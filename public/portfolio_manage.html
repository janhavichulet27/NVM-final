<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Portfolio - Dashboard</title>
  <style>
    /* Dark theme styling consistent with your dashboard/watchlist */
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
    }

    h1, h2 {
      color: #f0f0f0;
      margin-bottom: 12px;
    }

    .container {
      display: flex;
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
      gap: 24px;
    }

    .left-panel, .right-panel {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 20px;
      color: #eee;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
      font-size: 14px;
    }

    .left-panel {
      flex: 3;
      display: flex;
      flex-direction: column;
    }

    .right-panel {
      flex: 1;
      overflow-y: auto;
      max-height: 82vh;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
      color: #ddd;
    }

    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #333;
    }

    th {
      background: #272727;
      font-weight: 700;
      user-select: none;
      color: #ccc;
    }

    /* Button styling with blue color */
    button.action-btn {
      background: #0a74da;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      align-self: flex-start;
      margin-top: 10px;
      box-shadow: 0 0 8px rgba(10, 116, 218, 0.6);
    }

    button.action-btn:hover {
      background: #095cb2;
      box-shadow: 0 0 12px rgba(9, 92, 178, 0.8);
    }

    input[type=number],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      background: #2a2a2a;
      color: #eee;
      font-weight: 600;
      font-size: 1rem;
      box-sizing: border-box;
      transition: background-color 0.3s ease;
    }

    input[type=number]:focus,
    select:focus {
      outline: 2px solid #0a74da;
      background-color: #373737;
      color: #fff;
    }

    .form-row {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 6px;
      font-weight: 600;
      color: #bbb;
    }

    #tradeMessage {
      margin-top: 12px;
      font-weight: 600;
      min-height: 1.4em;
      color: #0a74da; /* Success color changed to blue */
    }

    .news-item {
      margin-bottom: 18px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }

    .news-item h4 {
      font-size: 16px;
      margin: 0 0 6px 0;
      color: #eee;
    }

    .news-item p {
      font-size: 14px;
      margin: 0;
      color: #bbb;
      line-height: 1.4;
    }

    .news-item a {
      color: #0a74da;
      text-decoration: none;
      font-weight: 600;
    }

    .news-item a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Manage Portfolio</h1>
  <div class="container">
    <section class="left-panel" aria-label="Portfolio management panel">
      <h2>Current Holdings</h2>
      <table>
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Company</th>
            <th>Shares</th>
            <th>Avg Price</th>
          </tr>
        </thead>
        <tbody id="holdingsBody"></tbody>
      </table>
      <h2>Buy / Sell Stocks</h2>
      <form id="tradeForm">
        <div class="form-row">
          <label for="tradeTicker">Ticker</label>
          <select id="tradeTicker" required>
            <option value="" disabled selected>Select ticker</option>
          </select>
        </div>
        <div class="form-row">
          <label for="tradeShares">Shares</label>
          <input type="number" id="tradeShares" min="1" step="1" required />
        </div>
        <div class="form-row">
          <label>Action</label>
          <select id="tradeAction" required>
            <option value="buy" selected>Buy</option>
            <option value="sell">Sell</option>
          </select>
        </div>
        <button type="submit" class="action-btn">Execute</button>
      </form>
      <div id="tradeMessage"></div>
    </section>
    <aside class="right-panel" aria-label="Major stocks news">
      <h2>Major Stocks News</h2>
      <div id="newsContainer">
        <p style="color:#666;">Loading news...</p>
      </div>
    </aside>
  </div>
  <script>
    const holdingsBody = document.getElementById('holdingsBody');
    const tradeForm = document.getElementById('tradeForm');
    const tradeTicker = document.getElementById('tradeTicker');
    const tradeShares = document.getElementById('tradeShares');
    const tradeAction = document.getElementById('tradeAction');
    const tradeMessage = document.getElementById('tradeMessage');
    const newsContainer = document.getElementById('newsContainer');

    // Load all tickers for <select>
    async function loadTickerOptions() {
      try {
        const resp = await fetch('/api/tickers');
        const tickers = await resp.json();
        tradeTicker.innerHTML = '<option value="" disabled selected>Select ticker</option>';
        tickers.forEach(({ ticker, company_name }) => {
          const option = document.createElement('option');
          option.value = ticker;
          option.textContent = `${ticker} - ${company_name}`;
          tradeTicker.appendChild(option);
        });
      } catch (err) {
        tradeTicker.innerHTML = '<option disabled>Error loading tickers</option>';
      }
    }

    // Load portfolio holdings
    async function loadHoldings() {
      try {
        const resp = await fetch('/api/portfolio');
        const holdings = await resp.json();
        holdingsBody.innerHTML = '';
        if (!holdings.length) {
          holdingsBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888;">No holdings to display</td></tr>';
          return;
        }
        holdings.forEach(stock => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${stock.ticker}</td>
            <td>${stock.company_name}</td>
            <td>${Number(stock.shares).toFixed(3)}</td>
            <td>$${Number(stock.avg_price).toFixed(2)}</td>
          `;
          holdingsBody.appendChild(tr);
        });
      } catch {
        holdingsBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#f44;">Error loading holdings</td></tr>';
      }
    }

    // Trade form handler
    tradeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const ticker = tradeTicker.value;
      const shares = Number(tradeShares.value);
      const action = tradeAction.value;
      tradeMessage.textContent = 'Processingâ€¦';
      tradeMessage.style.color = '#0a74da'; // blue success color
      try {
        const apiPath = (action === 'buy') ? '/api/portfolio/buy' : '/api/portfolio/sell';
        const resp = await fetch(apiPath, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker, shares })
        });
        const data = await resp.json();
        if (!resp.ok) {
          tradeMessage.textContent = 'Error: ' + (data.error || 'Unknown error');
          tradeMessage.style.color = '#f44336'; // error red
          return;
        }
        tradeMessage.textContent = `Success: ${action} ${shares} shares of ${ticker}`;
        await loadHoldings();
        tradeShares.value = '';
      } catch {
        tradeMessage.textContent = 'Network/server error during trade';
        tradeMessage.style.color = '#f44336';
      }
    });

    // Load news from backend (Finnhub API)
    async function loadNews() {
      try {
        const resp = await fetch('/api/major-news?ticker=AAPL');
        const articles = await resp.json();
        if (!articles || !articles.length) {
          newsContainer.innerHTML = `<p style="color:#888;">No news available.</p>`;
          return;
        }
        newsContainer.innerHTML = articles.map(n => {
          // Convert UNIX timestamp (seconds) to date string
          const dateObj = new Date(n.datetime * 1000);
          const publishedDate = dateObj.toISOString().slice(0, 10);
          return `
            <div class="news-item">
              <h4><a href="${n.url}" target="_blank" rel="noopener">${n.headline}</a></h4>
              <p>${publishedDate} &#8226; ${n.source || ''}</p>
              <p>${n.summary || ''}</p>
            </div>
          `;
        }).join('');
      } catch {
        newsContainer.innerHTML = `<p style="color:#f44336;">Error loading news.</p>`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadTickerOptions();
      loadHoldings();
      loadNews();
    });
  </script>
</body>
</html>
